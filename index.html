<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />

  <!-- üî• CLAVE PARA M√ìVIL -->
 <!-- VERSION: FIX-PROPERTY-08/01/2025 4:31 pm-OK -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <title>Airbnb AR Assistant</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      
    }

    a-scene {
      position: fixed;
      inset: 0;
      z-index: 1;
      
    }

    /* üî• UI ENCIMA DEL AR */
    #ui {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      gap: 8px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 12px;
    }

    #ui input {
      width: 220px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }

    #ui button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #00c853;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
    }
  </style>
</head>

<body>

  <!-- ESCENA AR -->
<a-scene
  embedded
  vr-mode-ui="enabled: false"
  arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
  device-orientation-permission-ui="enabled: false"
  cursor="rayOrigin: mouse"
>

  <a-camera position="0 0 0" look-controls="enabled: false">

  <a-entity
    id="arFloat"
    position="0 0 -2"
    animation="property: position;
               dir: alternate;
               dur: 3000;
               easing: easeInOutSine;
               loop: true;
               to: 0 0.12 -2">

    <a-entity id="arPanel" scale="0 0 0">

      <a-plane
        id="arPlane"
        width="1.8"
        height="1"
        color="#111"
        opacity="0.85"
        >
      </a-plane>

      <a-text
        id="arText"
        value=""
        width="1.4"
        color="#FFFFFF"
        align="center"
        position="0 0 0.15"
        wrap-count="28">
      </a-text>

    </a-entity>

  </a-entity>
</a-camera>
</a-scene>
  <!-- üî• UI HTML -->
  <div id="ui">
    <input
      id="questionInput"
      placeholder="Ej: ¬øA qu√© hora es el check-in?"
    />
  
    <button id="sendBtn" onclick="askAI()">Enviar</button>
  </div>
  <script>
  function getLanguageFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("lang");
  }

  function getBrowserLanguage() {
    return navigator.language || navigator.userLanguage || "es-ES";
  }

  function getCurrentLanguage() {
    return getLanguageFromURL() || getBrowserLanguage();
  }

  const CURRENT_LANG = getCurrentLanguage();
</script>

<script>
  const PROPERTY_CONFIG = {
  demo_property: {
    name: "Casa Playa Tamarindo",
    color: "#00c853",
    welcome: {
      es: "Bienvenido a Casa Playa Tamarindo, en que te puedo ayudar",
      en: "Welcome to Casa Playa Tamarindo üå¥"
    }
  },
  hotel_demo: {
    name: "Hotel Tamarindo",
    color: "#2196f3",
    welcome: {
      es: "Bienvenido al Hotel Tamarindo üè®",
      en: "Welcome to Hotel Tamarindo üè®"
    }
  },
   ferreteria_demo: {
    name: "Ferreteria Demo",
    color: "#2196f3",
    welcome: {
      es: "Bienvenido a ferreteria demo, buscas un producto, quieres saber de ofertas,pregunatame en que te puedo ayudar ",
      en: "Welcome to Hardware shop üè®"
    }
    
  }
};


  function getPropertyFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("property") || "demo_property";
}

const CURRENT_PROPERTY = getPropertyFromURL();
console.log("CURRENT_PROPERTY:", CURRENT_PROPERTY);
console.log("CONFIG:", PROPERTY_CONFIG[CURRENT_PROPERTY]);
</script>

  <script>
  let hideTimer = null;
  let currentUtterance = null;
  let audioUnlocked = false;
  

   function unlockAudio() {
    if (audioUnlocked) return;
    speechSynthesis.getVoices();
    const silent = new SpeechSynthesisUtterance("");
    silent.volume = 0;
    window.speechSynthesis.speak(silent);

  audioUnlocked = true;
}
  function applyBranding(playAudio = false) {
  const panel = document.getElementById("arPanel");
  const plane = document.getElementById("arPlane");
  const text = document.getElementById("arText");

  if (!panel || !plane || !text) return;

  const config = PROPERTY_CONFIG[CURRENT_PROPERTY];
  if (!config) return;

  plane.setAttribute("color", config.color);
  panel.setAttribute("scale", "1 1 1");
  panel.setAttribute("visible", "true");

  const langKey = CURRENT_LANG.startsWith("en") ? "en" : "es";
  showARAnswer(config.welcome[langKey], playAudio);
}



function pickBestVoice(lang) {
  const voices = window.speechSynthesis.getVoices();
  if (!voices || voices.length === 0) return null;

  // Normalizar
  const short = (lang || "es").toLowerCase().split("-")[0]; // "es-CR" -> "es"

  // 1) Match exacto por lang completo
  let v = voices.find(v => v.lang && v.lang.toLowerCase() === (lang || "").toLowerCase());
  if (v) return v;

  // 2) Match por idioma base (es, en)
  const candidates = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith(short));

  if (candidates.length === 0) return null;

  // 3) Preferencias de espa√±ol (evita voces raras si existen)
  if (short === "es") {
    const preferred = ["es-CR", "es-MX", "es-ES", "es-US"];
    for (const p of preferred) {
      const match = candidates.find(v => v.lang.toLowerCase() === p.toLowerCase());
      if (match) return match;
    }
  }

  // 4) Si no, usa la primera candidata
  return candidates[0];
}


 function getPreferredSpanishVoice() {
  const voices = speechSynthesis.getVoices();

  // Prioridad 1: Google espa√±ol
  let voice = voices.find(v => v.lang === "es-ES" && v.name.toLowerCase().includes("google"));
  if (voice) return voice;

  // Prioridad 2: Google espa√±ol US
  voice = voices.find(v => v.lang === "es-US" && v.name.toLowerCase().includes("google"));
  if (voice) return voice;

  // Prioridad 3: Microsoft Spanish Spain
  voice = voices.find(v => v.lang === "es-ES" && v.name.toLowerCase().includes("microsoft"));
  if (voice) return voice;

  // Prioridad 4: cualquier voz es-*
  voice = voices.find(v => v.lang.startsWith("es"));
  return voice || null;
}

function normalizeLang(lang) {
  if (!lang) return "es-ES";
  lang = lang.toLowerCase();

  if (lang.startsWith("es")) return "es-ES";
  if (lang.startsWith("en")) return "en-US";

  // fallback
  return "es-ES";
}

function pickBestVoice(targetLang) {
  const voices = speechSynthesis.getVoices();
  if (!voices || voices.length === 0) return null;

  const langPrefix = targetLang.split("-")[0]; // "es" o "en"

  // PRIORIDAD: Google voice en ese idioma
  let voice = voices.find(v =>
    v.lang.toLowerCase().startsWith(langPrefix) &&
    v.name.toLowerCase().includes("google")
  );
  if (voice) return voice;

  // SEGUNDA: Microsoft voice en ese idioma
  voice = voices.find(v =>
    v.lang.toLowerCase().startsWith(langPrefix) &&
    v.name.toLowerCase().includes("microsoft")
  );
  if (voice) return voice;

  // TERCERA: cualquier voz del idioma
  voice = voices.find(v => v.lang.toLowerCase().startsWith(langPrefix));
  if (voice) return voice;

  // fallback total
  return voices[0] || null;
}

function speak(text) {
  if (!text) return;

  // Cancelar lo anterior
  speechSynthesis.cancel();

  // Idioma seg√∫n tu CURRENT_LANG detectado
  const targetLang = normalizeLang(CURRENT_LANG);

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = targetLang;

  const voice = pickBestVoice(targetLang);
  if (voice) utterance.voice = voice;

  utterance.rate = 0.95;
  utterance.pitch = 1;
  utterance.volume = 1;

  speechSynthesis.speak(utterance);
}



function showARAnswer(text, speakAudio = true) {
 // const float = document.getElementById("arFloat");
  const panel = document.getElementById("arPanel");
  const arText = document.getElementById("arText");

  if (!panel || !arText) return;

    // Texto (forzar render)
  arText.setAttribute("value", "");
  setTimeout(() => {
    arText.setAttribute("value", text);
  }, 50);

    // Mostrar
  //float.setAttribute("visible", "true");
  panel.setAttribute("scale", "1 1 1");
   panel.setAttribute("visible", "true");

   if (speakAudio) speak(text);

    if (hideTimer) clearTimeout(hideTimer);
  hideTimer = setTimeout(() => {
    panel.setAttribute("scale", "0 0 0");
  }, 8000);

  //panel.setAttribute("animation__in", {
  //  property: "scale",
  //  from: "0.85 0.85 0.85",
  //  to: "1 1 1",
  //  dur: 300,
  //  easing: "easeOutBack"
 // });

    // Audio solo tras interacci√≥n
  //if (speakAudio) {
   // speak(text);
  //}

 // arText.setAttribute("value", text);
  //panel.setAttribute("scale", "1 1 1");

  // üîä HABLAR (idioma unificado)
 // speak(text);

  //if (hideTimer) clearTimeout(hideTimer);

  //hideTimer = setTimeout(() => {
  //  panel.setAttribute("scale", "0 0 0");
  //}, 8000);
}


 function setLoading(isLoading) {
  const btn = document.getElementById("sendBtn");
  const input = document.getElementById("questionInput");

  if (btn) {
    btn.disabled = isLoading;
    btn.textContent = isLoading ? "..." : "Enviar";
  }

  if (input) {
    input.disabled = isLoading;
  }
}

async function askAI() {
  

  unlockAudio();

  const input = document.getElementById("questionInput");
  if (!input || !input.value.trim()) return;

  const question = input.value.trim();

  try {
    setLoading(true);

    // UX: feedback inmediato
    showARAnswer("‚è≥ Pensando...", false);

    const res = await fetch(
      "https://gayla-subcalibre-destiny.ngrok-free.dev/ask",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          property_id: CURRENT_PROPERTY,
          question: question,
          //language: CURRENT_LANG
          language: CURRENT_LANG.startsWith("en") ? "en" : "es"
        })
      }
    );

    // Si backend respondi√≥ error
    if (!res.ok) {
      let detail = "";
      try {
        const err = await res.json();
        detail = err?.detail ? ` (${err.detail})` : "";
      } catch (e) {}

      showARAnswer("‚ö†Ô∏è Error del servidor. Intenta de nuevo." + detail, false);
      return;
    }

    const data = await res.json();

    const answer = data?.answer;
    if (!answer) {
      showARAnswer("‚ö†Ô∏è Respuesta vac√≠a. Intenta otra vez.", false);
      return;
    }

    showARAnswer(answer, true);
    input.value = "";

  } catch (err) {
    console.error("Fetch error:", err);
    showARAnswer("‚ö†Ô∏è Error de red. Revisa tu conexi√≥n o ngrok.", false);
  } finally {
    setLoading(false);
  }

 const data = await res.json();
    showARAnswer(data.answer  || "Error: no lleg√≥ respuesta del backend.");
    input.value = "";
}

speechSynthesis.onvoiceschanged = () => {
  console.log("‚úÖ Voces cargadas:", speechSynthesis.getVoices().length);
};
   
   
  
  </script>
  <script>
    const input = document.getElementById("questionInput");
    const scene = document.querySelector("a-scene");

    input.addEventListener("focus", () => {
      scene.style.visibility = "hidden";
      scene.style.pointerEvents = "none";
    });

    input.addEventListener("blur", () => {
       scene.style.visibility = "visible";
       scene.style.pointerEvents = "auto";
    });
</script>
<script>
 
 const sceneTest = document.querySelector("a-scene");

sceneTest.addEventListener("loaded", () => {
  applyBranding(false);
});


</script>

</body>
</html>
